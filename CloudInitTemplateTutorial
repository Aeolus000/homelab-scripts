Creating a cloud init template with AlmaLinux



QCOW2 is here: 
https://repo.almalinux.org/almalinux/9/cloud/x86_64/images/AlmaLinux-9-GenericCloud-latest.x86_64.qcow2

put this in on your proxmox node:
/var/lib/vz/template/qcow




on proxmox, create a VM, give it everything besides a hard disk and CD:

qm create 9000 \
  --name cloud-template \
  --memory 2048 \
  --cores 2 \
  --net0 virtio,bridge=vmbr0 \
  --scsihw virtio-scsi-pci \
  --ostype l26



Import the Alma qcow2 image into the VM, on local-lvm (or whatever storage you want)

qm importdisk 9000 /root/AlmaLinux-9-GenericCloud-latest.x86_64.qcow2 local-lvm


Set the disk to be that image:

qm set 9000 --scsi0 local-lvm:vm-9000-disk-0


Set disk as the first boot option:
qm set 9000 --boot c --bootdisk scsi0


I don't know what this actually does, sets it to cloudinit:
qm set 9000 --ide2 local-lvm:cloudinit

AlmaLinux apparently likes serial console connection more:
qm set 9000 --serial0 socket --vga serial0

Turn this into a template that we can clone from later as a base:
qm template 9000



When you want to create an image from that clone, just run a line here on Proxmox:

I've replaced specific information with mock variable names:

qm clone 9000 $VMID --name $hostname
qm set $VMID \
  --ciuser $user \
  --sshkey $SSHKeyPath \
  --ipconfig0 ip=$IP,gw=$Gateway \
  --nameserver $DNS \
  --searchdomain haydenlab.local
qm start $VMID
